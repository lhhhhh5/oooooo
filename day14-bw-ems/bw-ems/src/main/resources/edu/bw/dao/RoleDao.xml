<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="edu.bw.dao.RoleDao">
    <insert id="insert" parameterType="role">
        INSERT INTO bw_zzy_role
        <set>
            <if test="roleName!=null and roleName!=''">
                role_name=#{roleName}
            </if>
            <if test="permissions!=null and permissions !=''">
                ,permissions=#{permissions}
            </if>
            <if test="desc!=null and desc!=''">
                ,`desc`=#{desc}
            </if>
        </set>
    </insert>



    <select id="selectRoleByCondition" parameterType="selectRoleByConditionForm" resultType="map">
        SELECT r.id,
               r.role_name AS roleName,
               COUNT(u.id) AS users,
               JSON_LENGTH(r.permissions) AS permissions,
               r.`desc`,
               r.systemic
            FROM bw_zzy_role r
        LEFT JOIN bw_zzy_users u ON JSON_CONTAINS(u.role,CONVERT(r.id,CHAR))
        WHERE 1=1
        <if test="roleName!=null and roleName!=''">
            AND r.role_name LIKE #{roleName}
        </if>
        GROUP BY r.id
        ORDER BY r.id LIMIT #{start},#{length};
    </select>


    <select id="selectRoleByConditionCount" resultType="java.lang.Long" parameterType="selectRoleByConditionForm">
        SELECT COUNT(*)
        FROM (
            SELECT r.id
            FROM bw_zzy_role r
            LEFT JOIN bw_zzy_users u ON JSON_CONTAINS(u.role,CONVERT(r.id,CHAR))
            WHERE 1=1
              <if test="roleName !=null and roleName!=''">
                  AND r.role_name LIKE #{roleName}
              </if>
            GROUP BY r.id
             ) AS temp
    </select>


    <select id="selectById" resultType="java.util.Map" parameterType="Integer">
        SELECT id,role_name AS roleName ,
               permissions,
               `desc`,
               default_permissions AS defaultPermissions
        FROM bw_zzy_role WHERE id=#{id}
    </select>

    <update id="update" parameterType="updateRoleForm" >
        UPDATE bw_zzy_role
        <set>
            <if test="roleName!=null and roleName!=''">
                role_name = #{roleName}
            </if>
            <if test="permissions !=null and permissions !=''">
                , permissions =#{permissions}
            </if>
            <if test="desc!=null and desc!=''">
                , `desc` =#{desc}
            </if>
        </set>
        WHERE id =#{id}
    </update>



    <select id="selectCanDelete" resultType="java.lang.Boolean" parameterType="list">
        SELECT IF(SUM(temp.users)>0,FALSE,TRUE) AS result
        FROM  (
            SELECT COUNT(u.id) AS users
            FROM bw_zzy_role r
            JOIN bw_zzy_users u ON JSON_CONTAINS(u.role,CONVERT(r.id,CHAR))
            WHERE r.id IN
            <foreach collection="list" open="(" close=")" separator="," item="id">
                #{id}
            </foreach>
            GROUP BY r.id
              ) temp
    </select>

    <delete id="deleteRoleByIds" parameterType="Integer" >
        DELETE FROM bw_zzy_role
        WHERE id IN
        <foreach collection="list" item="id" separator="," close=")" open="(">
            #{id}
        </foreach>
        AND systemic = FALSE
    </delete>


    <select id="selectAllRole" resultType="map">
        SELECT id,
               role_name AS roleName,
               permissions ,
               `desc`,
               default_permissions AS defaultPermission,
               systemic
        FROM bw_zzy_role
        ORDER BY id
    </select>
</mapper>